---
description: Tutorial: Integrating MCP Servers
alwaysApply: false
---
# Tutorial: Integrating MCP Servers

## Quick Start

Add multiple MCP servers using a JSON array in AWS Secrets Manager. Tools are automatically namespaced by server name to prevent conflicts.

### 1. Add Secret

**Format:** JSON array of objects with `name`, `url`, and `auth` properties:

```json
[
  {
    "name": "shortio",
    "url": "https://ai-assistant.short.io/mcp",
    "auth": {
      "headerName": "authorization",
      "value": "sk_xxx"
    }
  },
  {
    "name": "github",
    "url": "https://api2.com/mcp",
    "auth": {
      "headerName": "x-api-key",
      "value": "Bearer ghp_xxx"
    }
  }
]
```

**Property Details:**
- **name** (optional): Server name for tool namespacing. Defaults to `server1`, `server2`, etc. if omitted
- **url** (required): MCP server endpoint URL
- **auth** (required): Object with authentication details
  - **headerName** (required): HTTP header name (e.g., `authorization`, `x-api-key`)
  - **value** (required): API key or token value

**Update Secret:**

```bash
# Get current secret
aws secretsmanager get-secret-value \
  --secret-id ws-mono-st/backend/integration/secrets \
  --profile wseng \
  --query SecretString | jq '.' > secret.json

# Add MCP_SERVERS key (edit secret.json)
{
  "MCP_SERVERS": "[{\"name\":\"shortio\",\"url\":\"https://ai-assistant.short.io/mcp\",\"auth\":{\"headerName\":\"authorization\",\"value\":\"sk_xxx\"}}]",
  ...existing keys...
}

# Update secret
aws secretsmanager put-secret-value \
  --secret-id ws-mono-st/backend/integration/secrets \
  --profile wseng \
  --secret-string file://secret.json && rm secret.json
```

**Common Header Formats:**
- Short.io: `"headerName": "authorization", "value": "sk_30JRJu4gZFAdyKtO"`
- GitHub-style: `"headerName": "authorization", "value": "Bearer ghp_xxx"`
- API Gateway: `"headerName": "x-api-key", "value": "abc123"`

### 2. Deploy

```bash
cd infra && ENVIRONMENT=integration pnpm cdk:deploy
```

### 3. Verify

```bash
aws logs tail /aws/lambda/ws-mono-st-integration-chat-api-handler \
  --profile wseng \
  --follow | grep MCP
```

Expected:
```
[INFO] Initializing MCP client { serverName: 'shortio', url: '...' }
[INFO] MCP client initialized successfully { serverName: 'shortio', toolCount: 3 }
[INFO] All MCP servers initialized { clientCount: 2, totalToolCount: 8, namespacedToolCount: 8 }
```

## Tool Namespacing

**Problem:** Multiple servers may have tools with the same name.

**Solution:** Tools are automatically namespaced by server name.

**Example with explicit names:**
```json
[
  {"name": "shortio", "url": "https://api1.com/mcp", "auth": {...}},
  {"name": "custom", "url": "https://api2.com/mcp", "auth": {...}}
]
```

Server "shortio" has tool "create_link" → Becomes: "shortio_create_link"
Server "custom" has tool "create_link" → Becomes: "custom_create_link"

Both coexist without conflict!

**Without names** (auto-assigned):
```json
[
  {"url": "https://api1.com/mcp", "auth": {...}},
  {"url": "https://api2.com/mcp", "auth": {...}}
]
```

Server 1 tools: server1_tool_name
Server 2 tools: server2_tool_name
## Removing MCP Servers

To remove an MCP server from the configuration:

1. Edit the `MCP_SERVERS` secret in AWS Secrets Manager
2. Remove the server object from the JSON array
3. When setting up be sure to remove the short.io server from the configuration.

## Architecture

```
Container → Parse JSON array → ChatService → Initialize each server
                                          → Use specified auth header
                                          → Namespace tools
                                          → Merge into single ToolSet
                                          → Pass to AI model
```

**Key Features:**
- ✅ Unlimited MCP servers (JSON array)
- ✅ Self-documenting JSON format with named properties
- ✅ Flexible auth headers (`authorization`, `x-api-key`, custom)
- ✅ Tool namespacing prevents conflicts
- ✅ Graceful per-server error handling
- ✅ Optional or auto-assigned server names
- ✅ Single ToolSet passed to AI model

## Troubleshooting

### No tools loaded
- Check JSON format is valid (use a JSON validator)
- Verify `MCP_SERVERS` is a properly escaped JSON string in the secret
- Check required fields: `url`, `auth.headerName`, `auth.value`
- Verify URL is HTTPS
- Check API key validity

### JSON parsing errors
- Ensure the JSON is properly escaped when stored in AWS Secrets Manager
- Use double quotes for all strings in JSON
- Validate JSON structure matches the format above

### Authentication errors (401/403)
- Verify `auth.headerName` matches server's expected format
- Check if API key needs "Bearer " prefix in `auth.value`
- Confirm API key is valid and not expired

### Tool name collisions (shouldn't happen)
- Tools are auto-namespaced by server name
- If you see collisions, check logs for duplicate server names

### Some servers fail
- Check logs for specific server errors
- Other servers continue working (graceful degradation)

## Related

- [Backend Architecture](../definitions/backend-architecture.mdc)
- [Adding a New Module](./adding-new-module.mdc)
